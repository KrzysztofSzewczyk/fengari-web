<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fengari</title>

    <link href="https://fonts.googleapis.com/css?family=Libre+Franklin:300,300i,400,400i,600,600i" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="github.css">
    <link rel="stylesheet" type="text/css" href="lua-web-cli.css">
</head>
<body>

    <div class="repl">
        <pre>
            <code class="lua" id="fengari-console"></code>
        </pre>
        <div class="fengari-input-container">
            <textarea id="fengari-input" rows="1"></textarea>
        </div>
    </div>

    <script src="src/web-cli.lua" type="text/lua" id="cli.lua">
        local js = require "js"

        -- Save references to lua baselib functions used
        local _G = _G
        local error = error
        local load = load
        local pack, unpack = table.pack, table.unpack
        local tostring = tostring
        local traceback = debug.traceback
        local xpcall = xpcall

        local document = js.global.document

        local output = document:getElementById("fengari-console")
        local input = document:getElementById("fengari-input")

        assert(output and input)

        local function triggerEvent(el, type)
            local e = document:createEvent("HTMLEvents")
            e:initEvent(type, false, true)
            el:dispatchEvent(e)
        end

        local function out(msg)
            output.textContent = output.textContent .. tostring(msg)
            output.scrollTop = output.scrollHeight
        end

        _G.print = function(...)
            local toprint = pack(...)

            for i = 1, toprint.n do
                if i > 1 then
                    out("\t")
                end

                out(tostring(toprint[i]))
            end

            out("\n")
        end

        local function doREPL()
            out("\n> " .. input.value .. "\n")

            if input.value.length == 0 then
                return
            end

            local fn, err = load("return " .. input.value, "stdin")
            if not fn then
                fn, err = load(input.value, "stdin")
            end

            if fn then
                local results = pack(xpcall(fn, traceback))
                if results[1] then
                    if results.n > 1 then
                        _G.print(unpack(results, 2, results.n))
                    end
                else
                    _G.print(results[2])
                end
            else
                _G.print(err)
            end

            input.value = ""

            triggerEvent(output, "change")
        end

        input.onkeypress = function(this, e)
            if not e then
                e = js.global.event
            end

            local keyCode = e.keyCode or e.which
            if keyCode == 13 and not e.shiftKey then
                doREPL()
                return false
            end
        end

        _G.print(_G._COPYRIGHT)
    </script>

    <script src="dist/fengari-web-cli-lua.js" type="text/javascript"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/lua.min.js"></script>

    <script>
        hljs.initHighlightingOnLoad();

        const fengari_console = document.getElementById('fengari-console');

        fengari_console.onchange = function() {
            hljs.highlightBlock(fengari_console);
        };
    </script>
</body>
</html>
